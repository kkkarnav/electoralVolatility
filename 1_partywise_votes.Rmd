---
title: "Where Does The Buck Stop? Economic Conditions & Electoral Volatility"
author: "Karnav Popat & Shashwat Agarwal"
date: "21/03/2024"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: vignette
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(dplyr)
library(lubridate)
library(kableExtra)
library(sf)
library(raster)
library(exactextractr)
```

```{r data, include=FALSE}
general <- read.csv("../TCPD/TCPD_GE_All_States_2023-2-2.csv")
assembly <- read.csv("../TCPD/All_States_AE.csv")

assembly_shp <- st_read("../shp/India_2014.geojson")
assembly_shp_old <- st_read("../shp/India_2013.geojson")
```

## Research Question

We know that voters punish incumbents when the economy goes sour. At what level of governance do voters allocate responsibility for economic underperformance? Any voter in India is under atleast three levels of governance: local representation, state government, and central government. In the United States, where popular perception of control is focused on the President, voters tend to punish the President's party. Does this hold true for India, where economic initiative is (or was) significantly more decentralized?

## Dependent Variable

To measure how voters reward and punish retrospective economic conditions, we use electoral volatility. We can calculate this for each constituency and each election using TCPD's election datasets.

```{r tcpd, include=FALSE}
kable(head(general), caption="General Elections Dataset")
kable(head(assembly), caption="Assembly Elections Dataset")
```

Some of the indicators used in Dash & Ferris are calculated at the constituency level, rather than being specific to candidate or party. These are the voter turnout (which indicates the level of democratic participation) and Effective Number of Parties (ENOP, which indicates the effective degree of choice that the voter has).

```{r vote_stats}
aggregate_electoral_indicators <- assembly %>%
  group_by(State_Name, Year, Constituency_Name)%>%
  summarize(total_votes=sum(Votes), Electors=first(Electors), Turnout_Percentage=first(Turnout_Percentage), ENOP=first(ENOP))
```

```{r vote_stats_table, echo=FALSE}
kable(head(aggregate_electoral_indicators), caption="Aggregate Electoral Indicators") %>%
  kable_styling(font_size=12)
```

More comprehensive measures of voting behaviour are calculated from one election to another. Electoral Volatility is expressed as:
$$
\frac{\sum_{p=1}^{n}V_{pt} - V_{p(t-1)}}{2}
$$
for each party _p_ between election _t_ and _t-1_. To calculate this, we first widen the dataset to get each party's voteshare in each election.

``` {r partywise}
# Aggregate the dataframe by party instead of by candidate
partywise_votes <- assembly %>%
  filter(last_poll == TRUE)%>%
  mutate(is_winner = ifelse(Position == 1, 1, 0))%>%
  group_by(State_Name, Constituency_No, Constituency_Name, Year, Assembly_No, Party)%>%
  summarize(Votes=sum(Votes), Valid_Votes=sum(Valid_Votes), Electors=first(Electors), Constituency_Type=first(Constituency_Type), Vote_Share_Percentage=sum(Vote_Share_Percentage), ENOP=first(ENOP), is_winner=first(is_winner))%>%
  ungroup()%>%
  group_by(State_Name, Constituency_No, Constituency_Name, Party)%>%
  mutate(is_incumbent = lag(is_winner, n=1))%>%
  mutate(is_incumbent = replace_na(is_incumbent, 0))%>%
  ungroup()%>%
  group_by(State_Name, Assembly_No, Party)%>%
  mutate(seats=sum(is_winner))%>%
  ungroup()%>%
  group_by(State_Name, Assembly_No)%>%
  mutate(state_incumbent = ifelse(seats == max(seats), 1, 0))%>%
  ungroup()
```

``` {r separate_vol}
incumbent_votes <- partywise_votes%>%
  filter(is_incumbent == 1)
kable(incumbent_votes)
```

``` {pivot}
# Extract the list of parties
party_list <- as.list(unique(partywise_votes$Party))

# Widen the dataframe for each party
for (party in party_list) {
  partywise_votes[[paste0("Party_", party)]] <- ifelse(partywise_votes$Party == party, partywise_votes$Vote_Share_Percentage, 0)
}
partywise_votes <- partywise_votes%>%
  dplyr::select(-Party, -Votes, -Valid_Votes)%>%
  group_by(State_Name, Constituency_No, Constituency_Name, Assembly_No, Year, Electors, Constituency_Type)%>%
  summarise_all(.funs = function(x) sum(x))%>%
  ungroup()
```

```{r partywise_votes_table, echo=FALSE}
kable(head(partywise_votes, 10), caption="Party-wise Vote Shares in Assembly Elections")%>%
  kable_styling(font_size=12)
# write.csv(partywise_votes, "./data/partywise_voteshare_constituency.csv", row.names=FALSE)
```
